(()=>{var e={};e.id=865,e.ids=[865],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},13365:(e,t,r)=>{"use strict";r.d(t,{A:()=>o});var n=r(79464),a=r(78388),s=r(44999);async function i(e){try{if(e){let t=e.headers.get("x-forwarded-for");if(t)return t.split(",")[0].trim();let r=e.headers.get("x-real-ip");if(r)return r}try{let e=await (0,s.b3)(),t=e.get("x-forwarded-for");if(t)return t.split(",")[0].trim();let r=e.get("x-real-ip");if(r)return r}catch{}return"unknown"}catch(e){return console.error("Error getting client IP:",e),"unknown"}}async function o({action:e,table_affected:t,record_id:r,performed_by:s,details:o,ip_address:c,request:d}){try{let u=c||await i(d);await n.z.auditLog.create({data:{log_id:await (0,a.$)("LOG"),action:e,table_affected:t,record_id:r,performed_by:s,details:o,ip_address:u}})}catch(e){console.error("Failed to write audit log:",e)}}},15008:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>g,routeModule:()=>m,serverHooks:()=>f,workAsyncStorage:()=>x,workUnitAsyncStorage:()=>w});var n={};r.r(n),r.d(n,{DELETE:()=>l,GET:()=>u,PUT:()=>p});var a=r(96559),s=r(48088),i=r(37719),o=r(32190),c=r(79464),d=r(13365);async function u(e,{params:t}){try{let{id:e}=await t,r=await c.z.expenseRecord.findUnique({where:{expense_id:e},include:{receipt:{include:{items:!0}}}});if(!r||r.is_deleted)return o.NextResponse.json({error:"Not found"},{status:404});return o.NextResponse.json(r)}catch(e){return console.error("GET /expenses/:id failed:",e),o.NextResponse.json({error:"Internal Server Error"},{status:500})}}async function p(e,{params:t}){try{let{id:r}=await t,{total_amount:n,expense_date:a,other_source:s,other_category:i}=await e.json(),u=await c.z.expenseRecord.findUnique({where:{expense_id:r},include:{receipt:!0}});if(!u)return o.NextResponse.json({error:"Record not found"},{status:404});let p=0;u.receipt&&(p=100*Math.abs((Number(n)-Number(u.receipt.total_amount_due))/Number(u.receipt.total_amount_due)));let l=await c.z.expenseRecord.update({where:{expense_id:r},data:{total_amount:n,expense_date:new Date(a),updated_at:new Date,other_source:"Other"===u.category?s:null,other_category:"Other"===u.category?i:null},include:{receipt:{include:{items:!0}}}}),m="Updated expense record. ";return Number(n)!==Number(u.total_amount)&&(m+=`Amount changed from ₱${u.total_amount} to ₱${n}. `,p>0&&(m+=`Deviation: ${p.toFixed(2)}%. `)),new Date(a).getTime()!==new Date(u.expense_date).getTime()&&(m+=`Date changed from ${u.expense_date} to ${a}. `),"Other"===u.category&&(s!==u.other_source&&(m+=`Source "${u.other_source}" → "${s}". `),i!==u.other_category&&(m+=`Category "${u.other_category}" → "${i}". `)),await (0,d.A)({action:"UPDATE",table_affected:"ExpenseRecord",record_id:r,performed_by:"ftms_user",details:m}),o.NextResponse.json(l)}catch(e){return console.error("PUT /expenses/:id failed:",e),o.NextResponse.json({error:"Internal Server Error"},{status:500})}}async function l(e,{params:t}){try{let{id:e}=await t,r=await c.z.expenseRecord.findUnique({where:{expense_id:e}});if(!r||r.is_deleted)return o.NextResponse.json({error:"Not found"},{status:404});if(r.assignment_id)try{await fetch(`https://dyvxlzuhnamrnqppehnv.supabase.co/rest/v1/op_bus_assignments?assignment_id=eq.${r.assignment_id}`,{method:"PATCH",headers:{"Content-Type":"application/json",apikey:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR5dnhsenVobmFtcm5xcHBlaG52Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgyNDM4ODUsImV4cCI6MjA2MzgxOTg4NX0.CKQLXvc4UUf55PHOj8FQuH-JeqVVpv1i4cwjKTVYxeE",Authorization:"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR5dnhsenVobmFtcm5xcHBlaG52Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgyNDM4ODUsImV4cCI6MjA2MzgxOTg4NX0.CKQLXvc4UUf55PHOj8FQuH-JeqVVpv1i4cwjKTVYxeE"},body:JSON.stringify({is_expense_recorded:!1})}),await c.z.assignmentCache.update({where:{assignment_id:r.assignment_id},data:{is_expense_recorded:!1,last_updated:new Date}})}catch(e){console.error("Assignment flag reset failed:",e)}return r.receipt_id&&await c.z.receipt.update({where:{receipt_id:r.receipt_id},data:{is_expense_recorded:!1}}),await c.z.expenseRecord.update({where:{expense_id:e},data:{is_deleted:!0,updated_at:new Date}}),await (0,d.A)({action:"DELETE",table_affected:"ExpenseRecord",record_id:e,performed_by:"ftms_user",details:`Soft-deleted record: ${JSON.stringify({category:r.category,amount:r.total_amount,date:r.expense_date})}`}),o.NextResponse.json({success:!0})}catch(t){console.error("DELETE /expenses/:id failed:",t);let e=t instanceof Error?t.message:"Unknown error";return o.NextResponse.json({error:"Internal Server Error",details:e},{status:500})}}let m=new a.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/expenses/[id]/route",pathname:"/api/expenses/[id]",filename:"route",bundlePath:"app/api/expenses/[id]/route"},resolvedPagePath:"C:\\Users\\Brian Caube\\OneDrive\\Documents\\capstone\\FTMS\\FTMS_JOEL\\ftms\\app\\api\\expenses\\[id]\\route.ts",nextConfigOutput:"",userland:n}),{workAsyncStorage:x,workUnitAsyncStorage:w,serverHooks:f}=m;function g(){return(0,i.patchFetch)({workAsyncStorage:x,workUnitAsyncStorage:w})}},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},78335:()=>{},78388:(e,t,r)=>{"use strict";r.d(t,{$:()=>s,B:()=>i});let n=new(r(96330)).PrismaClient,a={ASG:"AssignmentCache",LOG:"AuditLog",EXP:"ExpenseRecord",ITM:"Item",ITX:"ItemTransaction",RCP:"Receipt",RCI:"ReceiptItem",REV:"RevenueRecord"};async function s(e){if(!a[e])throw Error(`Invalid table prefix: ${e}`);return await n.$transaction(async t=>{let r=await t.sequence.upsert({where:{name:e},update:{value:{increment:1}},create:{name:e,value:1}});return`FTMS-${e}-${String(r.value).padStart(8,"0")}`})}async function i(){let e=new Date().toISOString().slice(0,10).replace(/-/g,"");return await n.$transaction(async t=>{let r=`XPT-${e}`,n=await t.sequence.upsert({where:{name:r},update:{value:{increment:1}},create:{name:r,value:1}});return`FTMS-XPT-${e}-${String(n.value).padStart(4,"0")}`})}},79464:(e,t,r)=>{"use strict";r.d(t,{z:()=>a});var n=r(96330);let a=globalThis.prisma??new n.PrismaClient},96330:e=>{"use strict";e.exports=require("@prisma/client")},96487:()=>{}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[447,580,999],()=>r(15008));module.exports=n})();