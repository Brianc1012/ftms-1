(()=>{var e={};e.id=673,e.ids=[673],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},13365:(e,t,r)=>{"use strict";r.d(t,{A:()=>o});var s=r(79464),a=r(78388),n=r(44999);async function i(e){try{if(e){let t=e.headers.get("x-forwarded-for");if(t)return t.split(",")[0].trim();let r=e.headers.get("x-real-ip");if(r)return r}try{let e=await (0,n.b3)(),t=e.get("x-forwarded-for");if(t)return t.split(",")[0].trim();let r=e.get("x-real-ip");if(r)return r}catch{}return"unknown"}catch(e){return console.error("Error getting client IP:",e),"unknown"}}async function o({action:e,table_affected:t,record_id:r,performed_by:n,details:o,ip_address:u,request:c}){try{let p=u||await i(c);await s.z.auditLog.create({data:{log_id:await (0,a.$)("LOG"),action:e,table_affected:t,record_id:r,performed_by:n,details:o,ip_address:p}})}catch(e){console.error("Failed to write audit log:",e)}}},27910:e=>{"use strict";e.exports=require("stream")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34631:e=>{"use strict";e.exports=require("tls")},39642:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>h,routeModule:()=>w,serverHooks:()=>f,workAsyncStorage:()=>m,workUnitAsyncStorage:()=>g});var s={};r.r(s),r.d(s,{GET:()=>x,POST:()=>l});var a=r(96559),n=r(48088),i=r(37719),o=r(32190),u=r(79464),c=r(78388),p=r(13365);let d=(0,r(86345).UU)("https://dyvxlzuhnamrnqppehnv.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR5dnhsenVobmFtcm5xcHBlaG52Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgyNDM4ODUsImV4cCI6MjA2MzgxOTg4NX0.CKQLXvc4UUf55PHOj8FQuH-JeqVVpv1i4cwjKTVYxeE");async function l(e){try{let{assignment_id:t,receipt_id:r,category:s,total_amount:a,expense_date:n,other_source:i,other_category:l}=await e.json(),x=Number(a);if("Other"===s){if(await u.z.expenseRecord.findFirst({where:{category:s,other_source:i||null,other_category:l||null,total_amount:x,expense_date:new Date(n),is_deleted:!1}}))return o.NextResponse.json({error:"Duplicate expense record found"},{status:409})}else if(t&&await u.z.expenseRecord.findFirst({where:{category:s,assignment_id:t,expense_date:new Date(n),is_deleted:!1}}))return o.NextResponse.json({error:"Duplicate expense record found for this assignment"},{status:409});if(r){let e=await u.z.receipt.findUnique({where:{receipt_id:r}});if(!e)return o.NextResponse.json({error:"Receipt not found"},{status:404});if(e.is_expense_recorded)return o.NextResponse.json({error:"Receipt is already linked to an expense"},{status:400});x=Number(e.total_amount_due),await u.z.receipt.update({where:{receipt_id:r},data:{is_expense_recorded:!0}})}if(t){let{error:e}=await d.from("op_bus_assignments").update({is_expense_recorded:!0}).eq("assignment_id",t);if(e)return console.error("Supabase update failed:",e),o.NextResponse.json({error:`Failed to update assignment status in Supabase: ${e.message}`},{status:500});await u.z.assignmentCache.update({where:{assignment_id:t},data:{is_expense_recorded:!0,last_updated:new Date}})}let w=await u.z.expenseRecord.create({data:{expense_id:await (0,c.$)("EXP"),assignment_id:t??null,receipt_id:r??null,category:s,total_amount:x,expense_date:new Date(n),created_by:"ftms_user",created_at:new Date,updated_at:null,is_deleted:!1,other_source:i||null,other_category:"Other"===s&&l||null},include:{receipt:{include:{items:!0}}}});return await (0,p.A)({action:"CREATE",table_affected:"ExpenseRecord",record_id:w.expense_id,performed_by:"ftms_user",details:`Created expense record with amount â‚±${x}${r?" with receipt":""}${t?" from assignment":""}`}),o.NextResponse.json(w)}catch(t){console.error("Failed to create expense:",t);let e=t instanceof Error?t.message:"An unknown error occurred";return o.NextResponse.json({error:"Internal Server Error",details:e},{status:500})}}async function x(e){let t=e.nextUrl.searchParams,r=t.get("dateFilter"),s=t.get("dateFrom"),a=t.get("dateTo"),n={};if(r){let e=new Date;switch(r){case"Day":n={expense_date:{gte:new Date(e.getFullYear(),e.getMonth(),e.getDate()),lt:new Date(e.getFullYear(),e.getMonth(),e.getDate()+1)}};break;case"Month":n={expense_date:{gte:new Date(e.getFullYear(),e.getMonth(),1),lte:new Date(e.getFullYear(),e.getMonth()+1,0)}};break;case"Year":n={expense_date:{gte:new Date(e.getFullYear(),0,1),lte:new Date(e.getFullYear(),11,31)}}}}else s&&a&&(n={expense_date:{gte:new Date(s),lte:new Date(a)}});let i=await u.z.expenseRecord.findMany({where:{is_deleted:!1,...n},include:{receipt:{include:{items:!0}}},orderBy:{created_at:"desc"}});return o.NextResponse.json(i)}let w=new a.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/expenses/route",pathname:"/api/expenses",filename:"route",bundlePath:"app/api/expenses/route"},resolvedPagePath:"C:\\Users\\Brian Caube\\OneDrive\\Documents\\capstone\\FTMS\\FTMS_JOEL\\ftms\\app\\api\\expenses\\route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:m,workUnitAsyncStorage:g,serverHooks:f}=w;function h(){return(0,i.patchFetch)({workAsyncStorage:m,workUnitAsyncStorage:g})}},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},78388:(e,t,r)=>{"use strict";r.d(t,{$:()=>n,B:()=>i});let s=new(r(96330)).PrismaClient,a={ASG:"AssignmentCache",LOG:"AuditLog",EXP:"ExpenseRecord",ITM:"Item",ITX:"ItemTransaction",RCP:"Receipt",RCI:"ReceiptItem",REV:"RevenueRecord"};async function n(e){if(!a[e])throw Error(`Invalid table prefix: ${e}`);return await s.$transaction(async t=>{let r=await t.sequence.upsert({where:{name:e},update:{value:{increment:1}},create:{name:e,value:1}});return`FTMS-${e}-${String(r.value).padStart(8,"0")}`})}async function i(){let e=new Date().toISOString().slice(0,10).replace(/-/g,"");return await s.$transaction(async t=>{let r=`XPT-${e}`,s=await t.sequence.upsert({where:{name:r},update:{value:{increment:1}},create:{name:r,value:1}});return`FTMS-XPT-${e}-${String(s.value).padStart(4,"0")}`})}},79428:e=>{"use strict";e.exports=require("buffer")},79464:(e,t,r)=>{"use strict";r.d(t,{z:()=>a});var s=r(96330);let a=globalThis.prisma??new s.PrismaClient},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96330:e=>{"use strict";e.exports=require("@prisma/client")},96487:()=>{}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[447,580,345,999],()=>r(39642));module.exports=s})();