(()=>{var e={};e.id=797,e.ids=[797],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},13365:(e,r,t)=>{"use strict";t.d(r,{A:()=>o});var n=t(79464),s=t(78388),a=t(44999);async function i(e){try{if(e){let r=e.headers.get("x-forwarded-for");if(r)return r.split(",")[0].trim();let t=e.headers.get("x-real-ip");if(t)return t}try{let e=await (0,a.b3)(),r=e.get("x-forwarded-for");if(r)return r.split(",")[0].trim();let t=e.get("x-real-ip");if(t)return t}catch{}return"unknown"}catch(e){return console.error("Error getting client IP:",e),"unknown"}}async function o({action:e,table_affected:r,record_id:t,performed_by:a,details:o,ip_address:u,request:c}){try{let d=u||await i(c);await n.z.auditLog.create({data:{log_id:await (0,s.$)("LOG"),action:e,table_affected:r,record_id:t,performed_by:a,details:o,ip_address:d}})}catch(e){console.error("Failed to write audit log:",e)}}},27910:e=>{"use strict";e.exports=require("stream")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34631:e=>{"use strict";e.exports=require("tls")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},54917:(e,r,t)=>{"use strict";t.r(r),t.d(r,{patchFetch:()=>x,routeModule:()=>v,serverHooks:()=>h,workAsyncStorage:()=>w,workUnitAsyncStorage:()=>g});var n={};t.r(n),t.d(n,{DELETE:()=>f,GET:()=>_,POST:()=>p,PUT:()=>m});var s=t(96559),a=t(48088),i=t(37719),o=t(32190),u=t(79464),c=t(74763),d=t(78388),l=t(13365);async function p(e){let{assignment_id:r,category:t,total_amount:n,collection_date:s,created_by:a}=await e.json();try{let e=n;if(r){if(await u.z.revenueRecord.findFirst({where:{assignment_id:r,collection_date:new Date(s)}}))return console.log(`Duplicate record found for assignment_id: ${r} on collection_date: ${s}`),o.NextResponse.json({error:"Revenue record for this assignment and collection_date already exists."},{status:409});let t=await (0,c.cc)(r);if(!t||null==t.trip_revenue)return console.log(`Assignment not found or missing trip_revenue for assignment_id: ${r}`),o.NextResponse.json({error:"Assignment not found or missing trip_revenue in Supabase"},{status:404});e=t.trip_revenue}let i=await u.z.revenueRecord.create({data:{revenue_id:await (0,d.$)("REV"),assignment_id:r??null,category:t,total_amount:e,collection_date:new Date(s),created_by:a,created_at:new Date,updated_at:null,is_deleted:!1}});return await (0,l.A)({action:"CREATE",table_affected:"RevenueRecord",record_id:i.revenue_id,performed_by:"ftms_user",details:`Created revenue record with amount ₱${e}`}),o.NextResponse.json(i)}catch(r){console.error("Failed to create revenue:",r);let e=r instanceof Error?r.message:"An unknown error occurred";return o.NextResponse.json({error:"Internal Server Error",details:e},{status:500})}}async function _(){let e=await u.z.revenueRecord.findMany({where:{is_deleted:!1},orderBy:{created_at:"desc"}});return o.NextResponse.json(e)}async function m(e,{params:r}){try{let{id:t}=await r,{total_amount:n,collection_date:s,other_source:a}=await e.json(),i=await u.z.revenueRecord.findUnique({where:{revenue_id:t}});if(!i||i.is_deleted)return o.NextResponse.json({error:"Revenue record not found"},{status:404});let d=null;if(i.assignment_id){let e=await (0,c.cc)(i.assignment_id);d=e?.trip_revenue}let p=null;null!=d&&(p=Math.abs((n-d)/d*100));let _=await u.z.revenueRecord.update({where:{revenue_id:t},data:{total_amount:n,collection_date:new Date(s),other_source:"Other"===i.category?a:null,updated_at:new Date}}),m=`Updated revenue record. Amount changed from ₱${i.total_amount} to ₱${n}.`;return null!==p&&(m+=` Deviation from original trip revenue: ${p.toFixed(2)}%`),await (0,l.A)({action:"UPDATE",table_affected:"RevenueRecord",record_id:t,performed_by:"ftms_user",details:m}),o.NextResponse.json(_)}catch(r){console.error("Failed to update revenue:",r);let e=r instanceof Error?r.message:"An unknown error occurred";return o.NextResponse.json({error:"Internal Server Error",details:e},{status:500})}}async function f(e,{params:r}){try{let{id:e}=await r,t=await u.z.revenueRecord.findUnique({where:{revenue_id:e}});if(!t)return o.NextResponse.json({error:"Revenue record not found"},{status:404});let n=await u.z.revenueRecord.update({where:{revenue_id:e},data:{is_deleted:!0,updated_at:new Date}});return await (0,l.A)({action:"DELETE",table_affected:"RevenueRecord",record_id:e,performed_by:"ftms_user",details:`Soft deleted revenue record with amount ₱${t.total_amount}`}),o.NextResponse.json(n)}catch(r){console.error("Failed to delete revenue:",r);let e=r instanceof Error?r.message:"An unknown error occurred";return o.NextResponse.json({error:"Internal Server Error",details:e},{status:500})}}let v=new s.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/revenues/[id]/route",pathname:"/api/revenues/[id]",filename:"route",bundlePath:"app/api/revenues/[id]/route"},resolvedPagePath:"C:\\Users\\Brian Caube\\OneDrive\\Documents\\capstone\\FTMS\\FTMS_JOEL\\ftms\\app\\api\\revenues\\[id]\\route.ts",nextConfigOutput:"",userland:n}),{workAsyncStorage:w,workUnitAsyncStorage:g,serverHooks:h}=v;function x(){return(0,i.patchFetch)({workAsyncStorage:w,workUnitAsyncStorage:g})}},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},63874:(e,r,t)=>{"use strict";t.d(r,{N:()=>n});let n=(0,t(86345).UU)("https://dyvxlzuhnamrnqppehnv.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR5dnhsenVobmFtcm5xcHBlaG52Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgyNDM4ODUsImV4cCI6MjA2MzgxOTg4NX0.CKQLXvc4UUf55PHOj8FQuH-JeqVVpv1i4cwjKTVYxeE")},74075:e=>{"use strict";e.exports=require("zlib")},74763:(e,r,t)=>{"use strict";t.d(r,{ZA:()=>c,cc:()=>o,gr:()=>u});var n=t(63874);let s="http://localhost:3000";async function a(){try{let e=await fetch(`${s}/api/assignments/cache`);if(!e.ok)return null;let{data:r}=await e.json();if(!r)return null;return r.map(e=>({assignment_id:e.assignment_id,bus_bodynumber:e.bus_bodynumber,bus_platenumber:e.bus_platenumber,bus_route:e.bus_route,bus_type:e.bus_type,driver_name:e.driver_name,conductor_name:e.conductor_name,date_assigned:new Date(e.date_assigned).toISOString(),trip_fuel_expense:Number(e.trip_fuel_expense),trip_revenue:Number(e.trip_revenue),is_revenue_recorded:e.is_revenue_recorded,is_expense_recorded:e.is_expense_recorded,assignment_type:e.assignment_type}))}catch(e){return console.error("Error fetching from cache:",e),null}}async function i(){try{if(!(await fetch(`${s}/api/assignments/cache`,{method:"POST"})).ok)throw Error("Failed to update cache")}catch(e){throw console.error("Error updating cache:",e),e}}async function o(e){try{let r=await a();if(r){let t=r.find(r=>r.assignment_id===e);if(t)return t}let{data:t,error:s}=await n.N.from("op_bus_assignments").select("*").eq("assignment_id",e).single();if(s)return console.error("Failed to fetch assignment from Supabase:",s),null;return await i(),t?{...t,trip_fuel_expense:Number(t.trip_fuel_expense),trip_revenue:Number(t.trip_revenue)}:null}catch(e){return console.error("Error in getAssignmentById:",e),null}}async function u(){try{let e=await a();if(e)return e;let{data:r,error:t}=await n.N.from("op_bus_assignments").select("*");if(t)throw Error(t.message);return await i(),r.map(e=>({...e,trip_fuel_expense:Number(e.trip_fuel_expense),trip_revenue:Number(e.trip_revenue),is_expense_recorded:!!e.is_expense_recorded,is_revenue_recorded:!!e.is_revenue_recorded}))}catch(e){throw console.error("Error fetching all assignments:",e),e}}async function c(e,r){try{let{data:t,error:s}=await n.N.from("op_bus_assignments").update({is_revenue_recorded:r}).eq("assignment_id",e).select();if(s)throw Error(`Failed to update is_revenue_recorded: ${s.message}`);return await i(),t}catch(e){throw console.error("Error updating assignment:",e),e}}},78335:()=>{},78388:(e,r,t)=>{"use strict";t.d(r,{$:()=>a,B:()=>i});let n=new(t(96330)).PrismaClient,s={ASG:"AssignmentCache",LOG:"AuditLog",EXP:"ExpenseRecord",ITM:"Item",ITX:"ItemTransaction",RCP:"Receipt",RCI:"ReceiptItem",REV:"RevenueRecord"};async function a(e){if(!s[e])throw Error(`Invalid table prefix: ${e}`);return await n.$transaction(async r=>{let t=await r.sequence.upsert({where:{name:e},update:{value:{increment:1}},create:{name:e,value:1}});return`FTMS-${e}-${String(t.value).padStart(8,"0")}`})}async function i(){let e=new Date().toISOString().slice(0,10).replace(/-/g,"");return await n.$transaction(async r=>{let t=`XPT-${e}`,n=await r.sequence.upsert({where:{name:t},update:{value:{increment:1}},create:{name:t,value:1}});return`FTMS-XPT-${e}-${String(n.value).padStart(4,"0")}`})}},79428:e=>{"use strict";e.exports=require("buffer")},79464:(e,r,t)=>{"use strict";t.d(r,{z:()=>s});var n=t(96330);let s=globalThis.prisma??new n.PrismaClient},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96330:e=>{"use strict";e.exports=require("@prisma/client")},96487:()=>{}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),n=r.X(0,[447,580,345,999],()=>t(54917));module.exports=n})();