(()=>{var e={};e.id=789,e.ids=[789],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},13365:(e,t,r)=>{"use strict";r.d(t,{A:()=>o});var n=r(79464),s=r(78388),a=r(44999);async function i(e){try{if(e){let t=e.headers.get("x-forwarded-for");if(t)return t.split(",")[0].trim();let r=e.headers.get("x-real-ip");if(r)return r}try{let e=await (0,a.b3)(),t=e.get("x-forwarded-for");if(t)return t.split(",")[0].trim();let r=e.get("x-real-ip");if(r)return r}catch{}return"unknown"}catch(e){return console.error("Error getting client IP:",e),"unknown"}}async function o({action:e,table_affected:t,record_id:r,performed_by:a,details:o,ip_address:u,request:c}){try{let l=u||await i(c);await n.z.auditLog.create({data:{log_id:await (0,s.$)("LOG"),action:e,table_affected:t,record_id:r,performed_by:a,details:o,ip_address:l}})}catch(e){console.error("Failed to write audit log:",e)}}},27910:e=>{"use strict";e.exports=require("stream")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34631:e=>{"use strict";e.exports=require("tls")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},63874:(e,t,r)=>{"use strict";r.d(t,{N:()=>n});let n=(0,r(86345).UU)("https://dyvxlzuhnamrnqppehnv.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR5dnhsenVobmFtcm5xcHBlaG52Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgyNDM4ODUsImV4cCI6MjA2MzgxOTg4NX0.CKQLXvc4UUf55PHOj8FQuH-JeqVVpv1i4cwjKTVYxeE")},68917:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>h,routeModule:()=>m,serverHooks:()=>w,workAsyncStorage:()=>g,workUnitAsyncStorage:()=>f});var n={};r.r(n),r.d(n,{GET:()=>_,POST:()=>p});var s=r(96559),a=r(48088),i=r(37719),o=r(32190),u=r(79464),c=r(74763),l=r(78388),d=r(13365);async function p(e){let{assignment_id:t,category:r,total_amount:n,collection_date:s,created_by:a,other_source:i}=await e.json();try{let e=n;if(t){if(await u.z.revenueRecord.findFirst({where:{assignment_id:t,collection_date:new Date(s)}}))return console.log(`Duplicate record found for assignment_id: ${t} on collection_date: ${s}`),o.NextResponse.json({error:"Revenue record for this assignment and collection_date already exists."},{status:409});let r=await (0,c.cc)(t);if(!r||null==r.trip_revenue)return console.log(`Assignment not found or missing trip_revenue for assignment_id: ${t}`),o.NextResponse.json({error:"Assignment not found or missing trip_revenue in Supabase"},{status:404});e=r.trip_revenue}let p=await u.z.revenueRecord.create({data:{revenue_id:await (0,l.$)("REV"),assignment_id:t??null,category:r,total_amount:e,collection_date:new Date(s),created_by:a,created_at:new Date,updated_at:null,is_deleted:!1,other_source:"Other"===r?i:null}});return await (0,d.A)({action:"CREATE",table_affected:"RevenueRecord",record_id:p.revenue_id,performed_by:a,details:`Created revenue record with amount â‚±${e}`}),o.NextResponse.json(p)}catch(t){console.error("Failed to create revenue:",t);let e=t instanceof Error?t.message:"An unknown error occurred";return o.NextResponse.json({error:"Internal Server Error",details:e},{status:500})}}async function _(e){let t=e.nextUrl.searchParams,r=t.get("dateFilter"),n=t.get("dateFrom"),s=t.get("dateTo"),a={};if(r){let e=new Date;switch(r){case"Day":a={collection_date:{gte:new Date(e.getFullYear(),e.getMonth(),e.getDate()),lt:new Date(e.getFullYear(),e.getMonth(),e.getDate()+1)}};break;case"Month":a={collection_date:{gte:new Date(e.getFullYear(),e.getMonth(),1),lte:new Date(e.getFullYear(),e.getMonth()+1,0)}};break;case"Year":a={collection_date:{gte:new Date(e.getFullYear(),0,1),lte:new Date(e.getFullYear(),11,31)}}}}else n&&s&&(a={collection_date:{gte:new Date(n),lte:new Date(s)}});let i=await u.z.revenueRecord.findMany({where:{is_deleted:!1,...a},orderBy:{created_at:"desc"}});return o.NextResponse.json(i)}let m=new s.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/revenues/route",pathname:"/api/revenues",filename:"route",bundlePath:"app/api/revenues/route"},resolvedPagePath:"C:\\Users\\Brian Caube\\OneDrive\\Documents\\capstone\\FTMS\\FTMS_JOEL\\ftms\\app\\api\\revenues\\route.ts",nextConfigOutput:"",userland:n}),{workAsyncStorage:g,workUnitAsyncStorage:f,serverHooks:w}=m;function h(){return(0,i.patchFetch)({workAsyncStorage:g,workUnitAsyncStorage:f})}},74075:e=>{"use strict";e.exports=require("zlib")},74763:(e,t,r)=>{"use strict";r.d(t,{ZA:()=>c,cc:()=>o,gr:()=>u});var n=r(63874);let s="http://localhost:3000";async function a(){try{let e=await fetch(`${s}/api/assignments/cache`);if(!e.ok)return null;let{data:t}=await e.json();if(!t)return null;return t.map(e=>({assignment_id:e.assignment_id,bus_bodynumber:e.bus_bodynumber,bus_platenumber:e.bus_platenumber,bus_route:e.bus_route,bus_type:e.bus_type,driver_name:e.driver_name,conductor_name:e.conductor_name,date_assigned:new Date(e.date_assigned).toISOString(),trip_fuel_expense:Number(e.trip_fuel_expense),trip_revenue:Number(e.trip_revenue),is_revenue_recorded:e.is_revenue_recorded,is_expense_recorded:e.is_expense_recorded,assignment_type:e.assignment_type}))}catch(e){return console.error("Error fetching from cache:",e),null}}async function i(){try{if(!(await fetch(`${s}/api/assignments/cache`,{method:"POST"})).ok)throw Error("Failed to update cache")}catch(e){throw console.error("Error updating cache:",e),e}}async function o(e){try{let t=await a();if(t){let r=t.find(t=>t.assignment_id===e);if(r)return r}let{data:r,error:s}=await n.N.from("op_bus_assignments").select("*").eq("assignment_id",e).single();if(s)return console.error("Failed to fetch assignment from Supabase:",s),null;return await i(),r?{...r,trip_fuel_expense:Number(r.trip_fuel_expense),trip_revenue:Number(r.trip_revenue)}:null}catch(e){return console.error("Error in getAssignmentById:",e),null}}async function u(){try{let e=await a();if(e)return e;let{data:t,error:r}=await n.N.from("op_bus_assignments").select("*");if(r)throw Error(r.message);return await i(),t.map(e=>({...e,trip_fuel_expense:Number(e.trip_fuel_expense),trip_revenue:Number(e.trip_revenue),is_expense_recorded:!!e.is_expense_recorded,is_revenue_recorded:!!e.is_revenue_recorded}))}catch(e){throw console.error("Error fetching all assignments:",e),e}}async function c(e,t){try{let{data:r,error:s}=await n.N.from("op_bus_assignments").update({is_revenue_recorded:t}).eq("assignment_id",e).select();if(s)throw Error(`Failed to update is_revenue_recorded: ${s.message}`);return await i(),r}catch(e){throw console.error("Error updating assignment:",e),e}}},78335:()=>{},78388:(e,t,r)=>{"use strict";r.d(t,{$:()=>a,B:()=>i});let n=new(r(96330)).PrismaClient,s={ASG:"AssignmentCache",LOG:"AuditLog",EXP:"ExpenseRecord",ITM:"Item",ITX:"ItemTransaction",RCP:"Receipt",RCI:"ReceiptItem",REV:"RevenueRecord"};async function a(e){if(!s[e])throw Error(`Invalid table prefix: ${e}`);return await n.$transaction(async t=>{let r=await t.sequence.upsert({where:{name:e},update:{value:{increment:1}},create:{name:e,value:1}});return`FTMS-${e}-${String(r.value).padStart(8,"0")}`})}async function i(){let e=new Date().toISOString().slice(0,10).replace(/-/g,"");return await n.$transaction(async t=>{let r=`XPT-${e}`,n=await t.sequence.upsert({where:{name:r},update:{value:{increment:1}},create:{name:r,value:1}});return`FTMS-XPT-${e}-${String(n.value).padStart(4,"0")}`})}},79428:e=>{"use strict";e.exports=require("buffer")},79464:(e,t,r)=>{"use strict";r.d(t,{z:()=>s});var n=r(96330);let s=globalThis.prisma??new n.PrismaClient},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96330:e=>{"use strict";e.exports=require("@prisma/client")},96487:()=>{}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[447,580,345,999],()=>r(68917));module.exports=n})();